net add node 0.0.0.0
net add node 0.0.0.1
net add node 0.0.0.2
net add node 0.0.0.3
net add node 0.0.0.4
net add link 0.0.0.0 0.0.0.1
net add link 0.0.0.0 0.0.0.2
net add link 0.0.0.1 0.0.0.0
net add link 0.0.0.1 0.0.0.2
net add link 0.0.0.1 0.0.0.3
net add link 0.0.0.2 0.0.0.0
net add link 0.0.0.2 0.0.0.1
net add link 0.0.0.2 0.0.0.3
net add link 0.0.0.3 0.0.0.1
net add link 0.0.0.3 0.0.0.2
net add link 0.0.0.4 0.0.0.4
net add link 0.0.0.4 0.0.0.4

bgp router 0.0.0.3 add network  [1.0.0.0/24]
bgp router 0.0.0.3 peer 0.0.0.1
    filter out
        add-rule
            match "prefix in [1.0.0.0/24]"
            allow
            exit
        add-rule
            match "prefix in [1.0.0.0/24]"
            action deny
            exit
        add-rule
            match "prefix in [0.0.0.0/0 le 32]"
            action deny
            exit
bgp router 0.0.0.3 peer 0.0.0.2
    filter out
        add-rule
            match "prefix in [1.0.0.0/24]"
            allow
            exit
        add-rule
            match "prefix in [1.0.0.0/24]"
            action deny
            exit
        add-rule
            match "prefix in [0.0.0.0/0 le 32]"
            action deny
            exit


bgp router 0.0.0.1 peer 0.0.0.0
    filter out
        add-rule 
            match "community is 23767"
            action "community add 2"
            exit
        add-rule 
            match "community is 23766"
            allow
            exit
        add-rule
            match "prefix in [1.0.0.0/24]"
            action deny
            exit
        add-rule
            match "prefix in [0.0.0.0/0 le 32]"
            action deny
            exit
bgp router 0.0.0.1 peer 0.0.0.2
    filter out
        add-rule 
            match "community is 23767"
            action "community add 2"
            exit
        add-rule 
            match "community is 23766"
            allow
            exit
        add-rule
            match "prefix in [1.0.0.0/24]"
            action deny
            exit
        add-rule
            match "prefix in [0.0.0.0/0 le 32]"
            action deny
            exit
    filter in
        add-rule
            match "prefix in [1.0.0.0/24]"
            action "community add 23766"
            action "local-pref 99"
            exit
bgp router 0.0.0.1 peer 0.0.0.3
    filter out
        add-rule 
            match "community is 23767"
            action "community add 2"
            exit
        add-rule 
            match "community is 23766"
            allow
            exit
        add-rule
            match "prefix in [1.0.0.0/24]"
            action deny
            exit
        add-rule
            match "prefix in [0.0.0.0/0 le 32]"
            action deny
            exit
    filter in
        add-rule
            match "prefix in [1.0.0.0/24]"
            action "community add 23767"
            action "local-pref 100"
            exit


bgp router 0.0.0.0 peer 0.0.0.1
    filter out
        add-rule 
            match "community is 23767"
            allow
            exit
        add-rule 
            match "community is 23766"
            allow
            exit
        add-rule
            match "prefix in [1.0.0.0/24]"
            action deny
            exit
        add-rule
            match "prefix in [0.0.0.0/0 le 32]"
            action deny
            exit
    filter in
        add-rule
            match "prefix in [1.0.0.0/24] & community is 2"
            action "community add 23767"
            action "local-pref 100"
            exit
        add-rule
            match "prefix in [1.0.0.0/24] & community is 1"
            action "community add 23766"
            action "local-pref 99"
            exit
bgp router 0.0.0.0 peer 0.0.0.2
    filter out
        add-rule 
            match "community is 23767"
            allow
            exit
        add-rule 
            match "community is 23766"
            allow
            exit
        add-rule
            match "prefix in [1.0.0.0/24]"
            action deny
            exit
        add-rule
            match "prefix in [0.0.0.0/0 le 32]"
            action deny
            exit
    filter in
        add-rule
            match "prefix in [1.0.0.0/24] & community is 1"
            action "community add 23766"
            action "local-pref 99"
            exit

sim run

